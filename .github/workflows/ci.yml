name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java: [ '17', '21' ]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java }}
          cache: 'maven'
      
      - name: ðŸ” Verify Maven configuration
        run: mvn --version
      
      - name: ðŸ“¦ Build with Maven
        run: mvn clean compile -B
      
      - name: ðŸ§ª Run unit tests
        run: mvn test -B -Dtest='!*IntegrationTest'
      
      - name: ðŸ“Š Generate test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Unit Test Results (JDK ${{ matrix.java }})
          path: 'target/surefire-reports/*.xml'
          reporter: java-junit
          fail-on-error: false
  
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    
    services:
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: gatling
          POSTGRES_PASSWORD: password
          POSTGRES_DB: gatling
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      
      - name: ðŸ”§ Initialize Postgres schema
        run: |
          PGPASSWORD=password psql -h localhost -U gatling -d gatling \
            -f src/main/resources/sql/create_requests_table.sql || true
      
      - name: ðŸ§ª Run integration tests with Testcontainers
        run: mvn test -B -Dtest='*IntegrationTest'
        env:
          TESTCONTAINERS_RYUK_DISABLED: false
      
      - name: ðŸ“Š Generate integration test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Integration Test Results
          path: 'target/surefire-reports/*.xml'
          reporter: java-junit
          fail-on-error: false
  
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      
      - name: ðŸ” Compile and verify
        run: mvn clean verify -DskipTests -B
      
      - name: ðŸ“ˆ Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts
          path: target/*.jar
          retention-days: 7
  
  docker-compose-test:
    name: Docker Compose Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Start services
        run: docker-compose up -d kafka redis postgres
      
      - name: â³ Wait for services
        run: |
          echo "Waiting for Kafka to be ready..."
          timeout 60 bash -c 'until docker exec gatling-kafka \
            kafka-broker-api-versions --bootstrap-server localhost:9092 2>/dev/null; do \
            echo "Waiting..."; sleep 2; done'
          echo "âœ… Kafka is ready"
          
          echo "Waiting for Redis to be ready..."
          timeout 30 bash -c 'until docker exec gatling-redis redis-cli ping 2>/dev/null; do \
            echo "Waiting..."; sleep 1; done'
          echo "âœ… Redis is ready"
          
          echo "Waiting for Postgres to be ready..."
          timeout 30 bash -c 'until docker exec gatling-postgres pg_isready -U gatling 2>/dev/null; do \
            echo "Waiting..."; sleep 1; done'
          echo "âœ… Postgres is ready"
      
      - name: ðŸ§ª Test Kafka connectivity
        run: |
          docker exec gatling-kafka kafka-topics --create \
            --bootstrap-server localhost:9092 \
            --topic test-topic \
            --partitions 4 \
            --replication-factor 1 || true
          
          docker exec gatling-kafka kafka-topics --list \
            --bootstrap-server localhost:9092
      
      - name: ðŸ“‹ Show logs on failure
        if: failure()
        run: docker-compose logs
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: docker-compose down -v
